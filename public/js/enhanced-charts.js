// Enhanced Charts for PEMS
class EnhancedCharts {
    constructor() {
        this.colors = {
            primary: '#3b82f6',
            secondary: '#10b981',
            accent: '#f59e0b',
            danger: '#ef4444',
            purple: '#8b5cf6',
            pink: '#ec4899',
            indigo: '#6366f1',
            teal: '#14b8a6',
            orange: '#f97316',
            emerald: '#059669'
        };
        
        this.gradients = {};
        this.init();
    }
    
    async init() {
        await this.loadChartJS();
        this.setupGradients();
        this.createEnhancedCategoryChart();
        this.createModernBudgetChart();
        this.createTrendChart();
    }
    
    async loadChartJS() {
        if (typeof Chart === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
            document.head.appendChild(script);
            
            return new Promise(resolve => {
                script.onload = resolve;
            });
        }
    }
    
    setupGradients() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // إنشاء تدرجات لونية جميلة
        this.gradients.blue = ctx.createLinearGradient(0, 0, 0, 400);
        this.gradients.blue.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
        this.gradients.blue.addColorStop(1, 'rgba(59, 130, 246, 0.1)');
        
        this.gradients.green = ctx.createLinearGradient(0, 0, 0, 400);
        this.gradients.green.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
        this.gradients.green.addColorStop(1, 'rgba(16, 185, 129, 0.1)');
        
        this.gradients.orange = ctx.createLinearGradient(0, 0, 0, 400);
        this.gradients.orange.addColorStop(0, 'rgba(245, 158, 11, 0.8)');
        this.gradients.orange.addColorStop(1, 'rgba(245, 158, 11, 0.1)');
    }
    
    createEnhancedCategoryChart() {
        const ctx = document.getElementById('enhancedCategoryChart');
        if (!ctx) return;
        
        // بيانات تجريبية محسنة
        const data = [
            { name: 'مصروفات الممثلين والفنانين', amount: 850000, color: this.colors.primary },
            { name: 'مصروفات الطعام والضيافة', amount: 620000, color: this.colors.secondary },
            { name: 'مصروفات الديكور والإكسسوار', amount: 380000, color: this.colors.accent },
            { name: 'مصروفات النقل والمواصلات', amount: 245000, color: this.colors.purple },
            { name: 'مصروفات المعدات والتقنية', amount: 180000, color: this.colors.pink }
        ];
        
        new Chart(ctx, {\n            type: 'bar',\n            data: {\n                labels: data.map(item => item.name),\n                datasets: [{\n                    label: 'المبلغ (ريال سعودي)',\n                    data: data.map(item => item.amount),\n                    backgroundColor: data.map(item => item.color),\n                    borderColor: data.map(item => item.color),\n                    borderWidth: 2,\n                    borderRadius: 8,\n                    borderSkipped: false,\n                    barThickness: 40,\n                    maxBarThickness: 50\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                indexAxis: 'y',\n                layout: {\n                    padding: {\n                        top: 20,\n                        bottom: 20,\n                        left: 20,\n                        right: 20\n                    }\n                },\n                plugins: {\n                    legend: {\n                        display: false\n                    },\n                    title: {\n                        display: true,\n                        text: 'المصروفات حسب الفئات',\n                        font: {\n                            size: 18,\n                            weight: 'bold',\n                            family: 'Cairo, sans-serif'\n                        },\n                        color: '#1f2937',\n                        padding: {\n                            top: 10,\n                            bottom: 30\n                        }\n                    },\n                    tooltip: {\n                        backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                        titleColor: '#ffffff',\n                        bodyColor: '#ffffff',\n                        borderColor: '#3b82f6',\n                        borderWidth: 1,\n                        cornerRadius: 8,\n                        displayColors: false,\n                        callbacks: {\n                            label: function(context) {\n                                const value = new Intl.NumberFormat('ar-SA', {\n                                    style: 'currency',\n                                    currency: 'SAR',\n                                    minimumFractionDigits: 0\n                                }).format(context.parsed.x);\n                                return `المبلغ: ${value}`;\n                            }\n                        }\n                    }\n                },\n                scales: {\n                    x: {\n                        beginAtZero: true,\n                        grid: {\n                            color: 'rgba(0, 0, 0, 0.05)',\n                            drawBorder: false\n                        },\n                        ticks: {\n                            font: {\n                                family: 'Cairo, sans-serif'\n                            },\n                            callback: function(value) {\n                                return new Intl.NumberFormat('ar-SA', {\n                                    notation: 'compact',\n                                    compactDisplay: 'short'\n                                }).format(value);\n                            }\n                        }\n                    },\n                    y: {\n                        grid: {\n                            display: false\n                        },\n                        ticks: {\n                            font: {\n                                family: 'Cairo, sans-serif',\n                                size: 12\n                            },\n                            color: '#374151',\n                            maxRotation: 0,\n                            callback: function(value, index) {\n                                const label = this.getLabelForValue(value);\n                                return label.length > 25 ? label.substring(0, 25) + '...' : label;\n                            }\n                        }\n                    }\n                },\n                animation: {\n                    duration: 1500,\n                    easing: 'easeInOutQuart'\n                },\n                interaction: {\n                    intersect: false,\n                    mode: 'index'\n                }\n            }\n        });\n    }\n    \n    createModernBudgetChart() {\n        const ctx = document.getElementById('modernBudgetChart');\n        if (!ctx) return;\n        \n        const data = {\n            labels: ['آمن', 'تحذير', 'خطر'],\n            datasets: [{\n                data: [65, 25, 10],\n                backgroundColor: [\n                    this.colors.secondary,\n                    this.colors.accent,\n                    this.colors.danger\n                ],\n                borderColor: '#ffffff',\n                borderWidth: 4,\n                hoverBorderWidth: 6,\n                hoverOffset: 15\n            }]\n        };\n        \n        new Chart(ctx, {\n            type: 'doughnut',\n            data: data,\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                cutout: '70%',\n                plugins: {\n                    legend: {\n                        position: 'bottom',\n                        labels: {\n                            padding: 25,\n                            usePointStyle: true,\n                            pointStyle: 'circle',\n                            font: {\n                                family: 'Cairo, sans-serif',\n                                size: 14,\n                                weight: '600'\n                            },\n                            color: '#374151'\n                        }\n                    },\n                    title: {\n                        display: true,\n                        text: 'حالة ميزانيات المشاريع',\n                        font: {\n                            size: 18,\n                            weight: 'bold',\n                            family: 'Cairo, sans-serif'\n                        },\n                        color: '#1f2937',\n                        padding: {\n                            top: 10,\n                            bottom: 20\n                        }\n                    },\n                    tooltip: {\n                        backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                        titleColor: '#ffffff',\n                        bodyColor: '#ffffff',\n                        borderColor: '#3b82f6',\n                        borderWidth: 1,\n                        cornerRadius: 8,\n                        callbacks: {\n                            label: function(context) {\n                                const total = context.dataset.data.reduce((a, b) => a + b, 0);\n                                const percentage = ((context.parsed / total) * 100).toFixed(1);\n                                return `${context.label}: ${percentage}%`;\n                            }\n                        }\n                    }\n                },\n                animation: {\n                    animateRotate: true,\n                    duration: 2000,\n                    easing: 'easeInOutQuart'\n                }\n            }\n        });\n    }\n    \n    createTrendChart() {\n        const ctx = document.getElementById('trendChart');\n        if (!ctx) return;\n        \n        const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'];\n        const expenseData = [850000, 920000, 780000, 1100000, 950000, 880000];\n        const budgetData = [1000000, 1000000, 1000000, 1200000, 1200000, 1200000];\n        \n        new Chart(ctx, {\n            type: 'line',\n            data: {\n                labels: months,\n                datasets: [\n                    {\n                        label: 'المصروفات الفعلية',\n                        data: expenseData,\n                        borderColor: this.colors.primary,\n                        backgroundColor: 'rgba(59, 130, 246, 0.1)',\n                        fill: true,\n                        tension: 0.4,\n                        pointBackgroundColor: this.colors.primary,\n                        pointBorderColor: '#ffffff',\n                        pointBorderWidth: 3,\n                        pointRadius: 6,\n                        pointHoverRadius: 8\n                    },\n                    {\n                        label: 'الميزانية المخططة',\n                        data: budgetData,\n                        borderColor: this.colors.secondary,\n                        backgroundColor: 'rgba(16, 185, 129, 0.1)',\n                        fill: false,\n                        tension: 0.4,\n                        borderDash: [5, 5],\n                        pointBackgroundColor: this.colors.secondary,\n                        pointBorderColor: '#ffffff',\n                        pointBorderWidth: 3,\n                        pointRadius: 6,\n                        pointHoverRadius: 8\n                    }\n                ]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: {\n                        position: 'top',\n                        labels: {\n                            padding: 20,\n                            usePointStyle: true,\n                            font: {\n                                family: 'Cairo, sans-serif',\n                                size: 14,\n                                weight: '600'\n                            },\n                            color: '#374151'\n                        }\n                    },\n                    title: {\n                        display: true,\n                        text: 'اتجاه المصروفات مقابل الميزانية',\n                        font: {\n                            size: 18,\n                            weight: 'bold',\n                            family: 'Cairo, sans-serif'\n                        },\n                        color: '#1f2937',\n                        padding: {\n                            top: 10,\n                            bottom: 20\n                        }\n                    },\n                    tooltip: {\n                        backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                        titleColor: '#ffffff',\n                        bodyColor: '#ffffff',\n                        borderColor: '#3b82f6',\n                        borderWidth: 1,\n                        cornerRadius: 8,\n                        callbacks: {\n                            label: function(context) {\n                                const value = new Intl.NumberFormat('ar-SA', {\n                                    style: 'currency',\n                                    currency: 'SAR',\n                                    minimumFractionDigits: 0\n                                }).format(context.parsed.y);\n                                return `${context.dataset.label}: ${value}`;\n                            }\n                        }\n                    }\n                },\n                scales: {\n                    x: {\n                        grid: {\n                            color: 'rgba(0, 0, 0, 0.05)',\n                            drawBorder: false\n                        },\n                        ticks: {\n                            font: {\n                                family: 'Cairo, sans-serif'\n                            },\n                            color: '#6b7280'\n                        }\n                    },\n                    y: {\n                        beginAtZero: true,\n                        grid: {\n                            color: 'rgba(0, 0, 0, 0.05)',\n                            drawBorder: false\n                        },\n                        ticks: {\n                            font: {\n                                family: 'Cairo, sans-serif'\n                            },\n                            color: '#6b7280',\n                            callback: function(value) {\n                                return new Intl.NumberFormat('ar-SA', {\n                                    notation: 'compact',\n                                    compactDisplay: 'short'\n                                }).format(value);\n                            }\n                        }\n                    }\n                },\n                animation: {\n                    duration: 2000,\n                    easing: 'easeInOutQuart'\n                },\n                interaction: {\n                    intersect: false,\n                    mode: 'index'\n                }\n            }\n        });\n    }\n}\n\n// تهيئة الرسوم البيانية المحسنة عند تحميل الصفحة\ndocument.addEventListener('DOMContentLoaded', () => {\n    new EnhancedCharts();\n});\n
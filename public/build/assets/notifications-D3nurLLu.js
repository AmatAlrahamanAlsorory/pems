class s{constructor(){this.init(),this.startPolling()}init(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission(),document.addEventListener("click",t=>{t.target.matches(".notification-item")&&this.markAsRead(t.target.dataset.id)})}startPolling(){setInterval(()=>{this.checkNotifications()},3e4),this.checkNotifications()}async checkNotifications(){try{const e=await(await fetch("/api/notifications/unread")).json();this.updateNotificationBadge(e.count),e.latest&&this.shouldShowNotification(e.latest)&&this.showBrowserNotification(e.latest)}catch(t){console.error("خطأ في جلب الإشعارات:",t)}}updateNotificationBadge(t){const e=document.querySelector(".notification-badge");e&&(e.textContent=t,e.style.display=t>0?"block":"none")}shouldShowNotification(t){const e=localStorage.getItem("last_notification_id");return t.id!=e}showBrowserNotification(t){if("Notification"in window&&Notification.permission==="granted"){const e=new Notification(t.title,{body:t.message,icon:"/icon-192.png",badge:"/icon-192.png",tag:`notification-${t.id}`,requireInteraction:t.level==="critical"});e.onclick=()=>{window.focus(),this.markAsRead(t.id),e.close()},t.level!=="critical"&&setTimeout(()=>e.close(),5e3),localStorage.setItem("last_notification_id",t.id)}}async markAsRead(t){try{await fetch(`/api/notifications/${t}/read`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json"}}),this.checkNotifications()}catch(e){console.error("خطأ في تحديث الإشعار:",e)}}showCriticalAlert(t,e="danger"){const i="alert-"+Date.now(),a=`
            <div id="${i}" class="alert alert-${e} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        ${this.getAlertIcon(e)}
                    </div>
                    <div class="flex-grow-1">
                        <strong>تنبيه هام!</strong><br>
                        <small>${t}</small>
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            </div>
        `;document.body.insertAdjacentHTML("beforeend",a),e==="danger"&&this.playNotificationSound(),setTimeout(()=>{const n=document.getElementById(i);n&&n.remove()},1e4)}getAlertIcon(t){const e={danger:'<i class="fas fa-exclamation-triangle text-red-500"></i>',warning:'<i class="fas fa-exclamation-circle text-yellow-500"></i>',success:'<i class="fas fa-check-circle text-green-500"></i>',info:'<i class="fas fa-info-circle text-blue-500"></i>'};return e[t]||e.info}playNotificationSound(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),i=t.createGain();e.connect(i),i.connect(t.destination),e.frequency.setValueAtTime(800,t.currentTime),i.gain.setValueAtTime(.3,t.currentTime),i.gain.exponentialRampToValueAtTime(.01,t.currentTime+.2),e.start(t.currentTime),e.stop(t.currentTime+.2)}catch{console.log("Audio not supported")}}}document.addEventListener("DOMContentLoaded",()=>{window.notificationSystem=new s});window.addEventListener("budget-exceeded",o=>{window.notificationSystem.showCriticalAlert(`تم تجاوز ميزانية المشروع: ${o.detail.project}`,"danger")});window.addEventListener("custody-approved",o=>{window.notificationSystem.showCriticalAlert(`تم اعتماد العهدة رقم: ${o.detail.custody}`,"success")});
